"0",""
"0","## Join tidy sectors and aggregate"
"0",""
"0","data_sectors <- data_crts %>% "
"0","  left_join(.,read.xlsx(""../Tidy-GHG-Inventories/data/cc_inventory_sectors.xlsx"",sheet=2) %>%"
"0","              select(sector_code,sector_tidy,sector_tidy_order),by=join_by(sector_code))"
"0",""
"0","data_sectors <- data_sectors %>% "
"0","  group_by(country,iso,sector_tidy,sector_tidy_order,year) %>% "
"0","  summarise(value=sum(value,na.rm=TRUE)/1e6)"
"0",""
"0",""
"0","## Join peak years and calculate changes"
"0",""
"0","data_sectors <- data_sectors %>% "
"0","  left_join(.,peak_years %>% ungroup() %>% filter(var==""value_inLUC"") %>% select(iso,peak_year),by=join_by(iso)) %>% "
"0","  group_by(country,iso) %>% "
"0","  filter(year %in% c(first(peak_year),max(year)))"
"0",""
"0","data_sectors <- data_sectors %>% "
"0","  group_by(country,iso,sector_tidy) %>% "
"0","  mutate(change_abs=last(value)-first(value),"
"0","         change_rel=change_abs/first(value))"
"0",""
"0",""
"0","plot_country_change <- function(countries,data_sectors) {"
"0","  "
"0","  ## Filter"
"0","  "
"0","  data_sectors <- data_sectors %>% "
"0","    filter(country==countries) "
"0","  "
"0","  "
"0","  ## Re-arrange order of sectors so that net additions come first, net reductions last"
"0","  "
"0","  data_sectors_order <- data_sectors %>% "
"0","    ungroup() %>% "
"0","    filter(year==max(data_sectors$year)) %>% "
"0","    arrange(desc(change_abs)) %>% "
"0","    mutate(order=row_number()) %>% "
"0","    select(sector_tidy,order)"
"0","  "
"0","  data_sectors <- data_sectors %>% "
"0","    left_join(.,data_sectors_order,by=join_by(sector_tidy)) %>% "
"0","    arrange(order,year)"
"0","  "
"0","  "
"0","  ## Get totals"
"0","  "
"0","  data_sectors_totals <- data_sectors %>% "
"0","    group_by(year) %>% "
"0","    summarise(value=sum(value,na.rm=T)) %>% "
"0","    mutate(label=paste0(""Emissions in "",year,"": "",signif(value,3)))"
"0","  "
"0","  "
"0","  ## Arrange data for waterfall"
"0","  "
"0","  data_sectors <- data_sectors  %>% "
"0","    ungroup() %>% "
"0","    filter(year==first(peak_year)) %>%"
"0","    add_row(order=0,change_abs=data_sectors_totals$value[1]) %>% "
"0","    arrange(order) %>% "
"0","    ungroup() %>%"
"0","    mutate(end = cumsum(change_abs),"
"0","           start = c(0, head(end, -1))) %>% "
"0","    filter(order!=0)"
"0","  "
"0","  "
"0","  ## Arrange levels, add labels"
"0","  data_sectors$sector_tidy <- gsub(""\\| "","""",data_sectors$sector_tidy)"
"0","  data_sectors$sector_tidy <- as.factor(data_sectors$sector_tidy)"
"0","  data_sectors$sector_tidy <- fct_reorder(data_sectors$sector_tidy,data_sectors$order)"
"0","  colours_custom <- c("
"0","    ""Energy Power"" = ""#17becfff"","
"0","    ""Energy Industry"" = ""#3a5e91ff"","
"0","    ""Energy Transport"" = ""#5185b5ff"","
"0","    ""Energy Buildings & other"" = ""#74a6d4ff"","
"0","    ""Energy Fuel production"" = ""#ff9055ff"","
"0","    ""Industrial processes"" = ""#e5b82cff"","
"0","    ""Agriculture"" = ""#4f8455ff"","
"0","    ""Land use change (LULUCF)"" = ""#7dd396ff"","
"0","    ""Waste"" = ""#818181ff"")"
"0","  "
"0","  "
"0","  data_sectors <- data_sectors %>%"
"0","    mutate(labels=signif(change_abs,3)) %>% "
"0","    mutate(labels=ifelse(labels>0,paste0(""+"",labels),labels))"
"0","  "
"0","  "
"0","  p1 <- data_sectors %>% "
"0","    ggplot(.,aes(fill = sector_tidy)) +"
"0","    geom_rect(aes(x = sector_tidy,xmin = order - 0.2, xmax = order + 0.2, ymin = end, ymax = start),color=""#252525"",linewidth=0.25) +"
"0","    geom_segment(data=data_sectors %>% filter(order!=max(data_sectors$order)),"
"0","                 aes(x = order + 0.2, xend = order + 0.8,y = end, yend = end),"
"0","                 color = ""#252525"",linewidth=0.25) +"
"0","    scale_x_discrete(labels = function(x) str_wrap(x, width = 10),expand = expansion(mult = c(0.05, 0.05))) +"
"0","    scale_y_continuous(breaks=data_sectors_totals$value) +"
"0","    scale_fill_manual(values=colours_custom) +"
"0","    theme_wl() +"
"0","    theme(legend.position=""none"","
"0","          axis.title = element_blank(),"
"0","          panel.grid.major.x = element_blank(),"
"0","          axis.text.x = element_text(vjust = 1),"
"0","          plot.title = element_text(margin=margin(t=15)),"
"0","          axis.text.y = element_blank(),"
"0","          axis.ticks.y = element_blank()) +"
"0","    labs(title=countries,"
"0","         subtitle=bquote(paste(""Change in total GHG emissions incl. land use change since peak (MtCO""[2], ""e)"")),"
"0","         caption=""⌂ Data: UNFCCC, Tidy GHG Inventories   ⌂ CC-BY William F. Lamb  \n⌂ Note: GWP100 AR6; net land use change (LULUCF) emissions based on inventories"") +"
"0","    coord_cartesian(clip = ""off"")"
"0","  "
"0","  "
"0","  y_range_scaling <- layer_scales(p1)$y$range$range"
"0","  y_range_scaling <- diff(y_range_scaling) * 0.08"
"0","  "
"0","  "
"0","  p1 <- p1 +"
"0","    geom_text(aes(x=sector_tidy,y=ifelse(change_abs>0,end+y_range_scaling,end+y_range_scaling-change_abs),label=labels),"
"0","              color=""#636363"","
"0","              size=3.5)"
"0","  "
"0","  y_range_scaling_2 <- layer_scales(p1)$y$range$range"
"0","  y_range_expanded <- y_range_scaling_2 + c(-0.001 * diff(y_range_scaling_2),0.001 * diff(y_range_scaling_2))"
"0","  "
"0","  p2 <- data_sectors_totals %>%"
"0","    filter(year==data_sectors_totals$year[2]) %>% "
"0","    ggplot(.,aes(x=1.5,y=value,label=str_wrap(label,15))) +"
"0","    geom_text(size=3.5,colour=""#636363"",hjust=0) +"
"0","    geom_segment(aes(x = 1.4, xend = 1, yend = value),"
"0","                 arrow = arrow(length = unit(0.2, ""cm"")),"
"0","                 colour = ""#636363"") +"
"0","    scale_y_continuous(limits = y_range_expanded) +"
"0","    scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0, 0.05))) +"
"0","    theme_wl_empty() +"
"0","    coord_cartesian(clip = ""off"")"
"0","  "
"0","  p3 <- data_sectors_totals %>%"
"0","    filter(year==data_sectors_totals$year[1]) %>% "
"0","    ggplot(.,aes(x=4,y=value,label=str_wrap(label,15))) +"
"0","    geom_text(size=3.5,colour=""#636363"",hjust=1) +"
"0","    geom_segment(aes(x = 4.1, xend = 4.5, yend = value),"
"0","                 arrow = arrow(length = unit(0.2, ""cm"")),"
"0","                 colour = ""#636363"") +"
"0","    scale_y_continuous(limits = y_range_expanded) +"
"0","    scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0.05, 0))) +"
"0","    theme_wl_empty() +"
"0","    coord_cartesian(clip = ""off"")"
"0","  "
"0","  "
"0","  plot <- plot_spacer() + p3 + plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-0.26,1,-0.26,6,-0.26,1))"
"0","  plot"
"0","  return(plot)"
"0","}"
"0",""
"0",""
"0",""
"0","plot_country_change(""Germany"",data_sectors)"
